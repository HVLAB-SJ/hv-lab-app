# 토스페이 즉시송금 설정 가이드

토스페이 API를 사용하여 결제요청에서 즉시송금 기능을 사용할 수 있습니다.

## 1. 토스뱅크 사업자 계좌 개설

### 필수 요건
- 토스뱅크 사업자 계좌가 필요합니다
- 개인 계좌로는 송금 API를 사용할 수 없습니다

### 계좌 개설 방법
1. 토스 앱 설치 및 회원가입
2. 앱 내에서 '토스뱅크 사업자 계좌' 신청
3. 사업자등록증 등 서류 제출
4. 심사 완료 후 계좌 개설 (보통 1-2일 소요)

---

## 2. 토스페이 API 신청

### 신청 경로
https://toss.im/business

### 신청 절차
1. 위 링크 접속
2. 'API 서비스 신청' 클릭
3. 사업자 정보 입력
   - 사업자등록번호
   - 대표자명
   - 사업장 주소
   - 담당자 연락처
4. 토스뱅크 계좌 연동
5. 송금 서비스 선택 및 신청

### 심사 기간
- 보통 3-5 영업일 소요
- 승인 시 이메일로 API 키 발급 안내

---

## 3. API 키 발급

심사 승인 후 토스페이 개발자센터에서 API 키를 발급받습니다.

### 발급 방법
1. 토스페이 개발자센터 로그인: https://developers.tosspayments.com
2. '내 앱' > '새 앱 만들기'
3. 앱 이름 입력 (예: HV LAB 결제시스템)
4. API 키 발급
   - **API Key** (라이브 키): `live_api_xxxxxxxxxx`
   - **Secret Key** (시크릿 키): `live_secret_xxxxxxxxxx`

### 테스트 키 (개발용)
개발 및 테스트 시에는 테스트 키를 사용하세요:
- API Key: `test_api_xxxxxxxxxx`
- Secret Key: `test_secret_xxxxxxxxxx`

⚠️ **주의**: 테스트 키로는 실제 송금이 이루어지지 않습니다.

---

## 4. 환경 변수 설정

`.env` 파일에 다음 설정을 추가하세요:

```env
# 토스페이 송금 API
TOSSPAY_API_KEY=live_api_xxxxxxxxxx
TOSSPAY_SECRET_KEY=live_secret_xxxxxxxxxx
TOSSPAY_SENDER_ACCOUNT=1002-XXX-XXXX

# 개발/테스트 시
# TOSSPAY_API_KEY=test_api_xxxxxxxxxx
# TOSSPAY_SECRET_KEY=test_secret_xxxxxxxxxx
# TOSSPAY_SENDER_ACCOUNT=1002-000-0000
```

### 설정 항목 설명
- `TOSSPAY_API_KEY`: 토스페이에서 발급받은 API 키
- `TOSSPAY_SECRET_KEY`: 토스페이에서 발급받은 시크릿 키
- `TOSSPAY_SENDER_ACCOUNT`: 송금에 사용할 토스뱅크 계좌번호 (하이픈 포함)

---

## 5. 서버 재시작

환경 변수 설정 후 서버를 재시작하세요:

```bash
# Railway 배포 시
railway up

# 로컬 개발 시
npm start
```

---

## 6. 사용 방법

### 즉시송금 버튼 사용
1. 결제요청 페이지 접속
2. '대기중' 탭에서 송금할 결제 확인
3. **'즉시송금'** 버튼 클릭
4. 송금 확인 창에서 정보 확인
5. 확인 버튼 클릭
6. 자동으로 송금 완료 처리

### 송금 한도 확인
토스페이 API는 일일 송금 한도가 있습니다:
- 개발자센터에서 한도 확인 가능
- 앱에서 한도 조회 API 사용 가능

---

## 7. 주요 기능

### ✅ 구현된 기능
- **즉시송금**: 버튼 클릭 시 자동으로 송금 실행
- **자동 상태 업데이트**: 송금 완료 시 자동으로 '송금완료' 상태로 변경
- **송금 내역 저장**: DB에 송금 ID 저장
- **송금 한도 조회**: 남은 송금 한도 확인 가능
- **송금 조회**: 과거 송금 내역 조회 가능

### 📋 지원 은행
- KB국민은행, 신한은행, 우리은행, 하나은행
- NH농협은행, IBK기업은행
- 카카오뱅크, 토스뱅크, 케이뱅크
- 지방은행 (대구, 부산, 경남, 광주, 전북, 제주은행)
- 새마을금고, 신협, 우체국

---

## 8. 수수료

### 토스페이 송금 수수료
- 토스뱅크 간: **무료**
- 타 은행: **200원 ~ 500원** (금액에 따라 상이)
- 정확한 수수료는 토스페이 개발자센터에서 확인하세요

---

## 9. 문제 해결

### API 키 오류
```
Error: 토스페이 API 키 또는 송금 계좌가 설정되지 않았습니다.
```
→ `.env` 파일에 API 키가 올바르게 설정되었는지 확인
→ 서버 재시작 필요

### 지원하지 않는 은행
```
Error: 지원하지 않는 은행입니다: OO은행
```
→ `server/utils/tosspay-transfer.js`의 `getBankCode()` 함수에 은행 추가

### 송금 한도 초과
```
Error: 일일 송금 한도를 초과했습니다.
```
→ 토스페이 개발자센터에서 한도 증액 신청
→ 또는 다음날 다시 시도

### 계좌 오류
```
Error: 계좌번호가 올바르지 않습니다.
```
→ 받는 사람 계좌번호 확인
→ 하이픈 제거된 숫자만 입력되어야 함

---

## 10. 보안 주의사항

⚠️ **중요**: 다음 사항을 반드시 지키세요

1. **API 키 보안**
   - API 키와 시크릿 키를 절대 GitHub 등에 업로드하지 마세요
   - `.env` 파일은 `.gitignore`에 추가되어 있어야 합니다
   - Railway 등 배포 환경에서는 환경변수로 설정하세요

2. **권한 관리**
   - 즉시송금 기능은 manager, admin만 사용 가능하도록 설정됨
   - 일반 사용자는 송금 버튼이 보이지 않습니다

3. **송금 확인**
   - 송금 전 반드시 확인 창이 표시됩니다
   - 계좌번호, 금액을 다시 한 번 확인하세요

---

## 11. 참고 링크

- 토스페이 비즈니스: https://toss.im/business
- 토스페이먼츠 개발자센터: https://developers.tosspayments.com
- 토스뱅크: https://www.tossbank.com
- API 문서: https://docs.tosspayments.com

---

## 문의

토스페이 API 관련 문의사항은 토스페이먼츠 고객센터로 연락하세요:
- 전화: 1544-7772
- 이메일: support@tosspayments.com

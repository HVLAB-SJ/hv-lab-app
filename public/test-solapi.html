<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLAPI 테스트</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #FDB514;
            padding-bottom: 10px;
        }
        .section {
            margin: 30px 0;
        }
        .status-card {
            background: #f8f9fa;
            border-left: 4px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #FDB514;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e5a112;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .urgent-toggle {
            margin: 20px 0;
        }
        .urgent-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .urgent-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .log-entry.info { border-left-color: #17a2b8; }
        .log-entry.success { border-left-color: #28a745; }
        .log-entry.warning { border-left-color: #ffc107; }
        .log-entry.error { border-left-color: #dc3545; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FDB514;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 SOLAPI 알림톡 테스트</h1>

        <div class="section">
            <h2>📋 환경설정 상태</h2>
            <div id="configStatus">
                <div class="status-card">
                    <span class="spinner"></span> 설정을 확인하는 중...
                </div>
            </div>
        </div>

        <div class="section">
            <h2>📤 테스트 발송</h2>
            <div class="urgent-toggle">
                <label>
                    <input type="checkbox" id="urgentCheck">
                    <span>긴급 발송 (SMS 추가 발송)</span>
                </label>
            </div>
            <button id="testBtn" onclick="sendTest()" disabled>
                알림톡 테스트 발송
            </button>
            <button onclick="checkConfig()">
                설정 다시 확인
            </button>
        </div>

        <div class="section">
            <h2>📝 실행 로그</h2>
            <div id="logs" class="log-area">
                <div class="log-entry info">테스트 페이지가 로드되었습니다.</div>
            </div>
        </div>

        <div class="section">
            <h2>🔍 템플릿 정보</h2>
            <button onclick="checkTemplate()" class="btn btn-secondary">
                템플릿 정보 확인
            </button>
            <div id="templateInfo" class="status-card" style="margin-top: 10px; display: none;">
            </div>
        </div>

        <div class="section">
            <h2>❓ 도움말</h2>
            <div class="status-card">
                <strong>알림톡이 안 오는 경우 확인사항:</strong><br>
                1. <strong>템플릿 ID</strong>가 올바른지 확인<br>
                   - SOLAPI 관리자에서 승인된 템플릿 ID 확인<br>
                   - Railway Variables에 SOLAPI_TEMPLATE_ID 설정<br><br>

                2. <strong>템플릿 변수</strong>가 일치하는지 확인<br>
                   - 변수명: 프로젝트명, 금액, 예금주, 은행명, 계좌번호<br>
                   - #{변수명} 형식으로 템플릿에 등록<br><br>

                3. <strong>발신번호</strong>가 SOLAPI에 등록되었는지 확인<br>
                   - SOLAPI 관리자에서 발신번호 사전 등록 필요<br><br>

                4. <strong>수신번호</strong>가 올바른지 확인<br>
                   - ADMIN_PHONE_NUMBERS에 정확한 번호 입력<br><br>

                <strong>Railway 환경변수 설정:</strong><br>
                - SOLAPI_API_KEY<br>
                - SOLAPI_API_SECRET<br>
                - SOLAPI_PFID (채널 ID)<br>
                - SOLAPI_TEMPLATE_ID (템플릿 ID)<br>
                - SOLAPI_FROM_NUMBER (발신번호)<br>
                - ADMIN_PHONE_NUMBERS (수신번호들)
            </div>
        </div>
    </div>

    <script>
        let token = null;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        async function login() {
            try {
                addLog('로그인 시도 중...', 'info');
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: '상준', password: '0109' })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    addLog('로그인 성공', 'success');
                    return true;
                } else {
                    addLog('로그인 실패', 'error');
                    return false;
                }
            } catch (error) {
                addLog(`로그인 오류: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkTemplate() {
            const templateDiv = document.getElementById('templateInfo');

            if (!token) {
                await login();
            }

            try {
                addLog('템플릿 정보 확인 중...', 'info');
                const response = await fetch('/api/test/template', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    templateDiv.style.display = 'block';
                    templateDiv.innerHTML = `
                        <strong>템플릿 정보:</strong><br>
                        템플릿 ID: <code>${data.templateId}</code><br>
                        채널 ID: <code>${data.pfId}</code><br><br>
                        <strong>예상 템플릿 형식:</strong><br>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">${data.templateExample}</pre>
                        <strong>변수:</strong> ${data.expectedVariables.join(', ')}<br><br>
                        <em>${data.note}</em>
                    `;
                    addLog('템플릿 정보 로드 완료', 'success');
                } else {
                    addLog('템플릿 정보 로드 실패', 'error');
                }
            } catch (error) {
                addLog(`템플릿 정보 오류: ${error.message}`, 'error');
            }
        }

        async function checkConfig() {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.innerHTML = '<div class="status-card"><span class="spinner"></span> 설정을 확인하는 중...</div>';

            if (!token) {
                const loginSuccess = await login();
                if (!loginSuccess) {
                    statusDiv.innerHTML = '<div class="status-card error">❌ 로그인 실패</div>';
                    return;
                }
            }

            try {
                addLog('SOLAPI 설정 확인 중...', 'info');
                const response = await fetch('/api/test/config', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    let html = '';
                    if (data.configured) {
                        html = '<div class="status-card success">✅ 모든 설정이 완료되었습니다</div>';
                        document.getElementById('testBtn').disabled = false;
                        addLog('설정 확인 완료 - 모든 환경변수가 설정됨', 'success');
                    } else {
                        html = '<div class="status-card warning">⚠️ 일부 설정이 누락되었습니다</div>';
                        document.getElementById('testBtn').disabled = true;
                        addLog('설정 확인 완료 - 일부 환경변수 누락', 'warning');
                    }

                    html += '<div class="status-card">';
                    html += '<strong>설정 상태:</strong><br>';
                    html += `API Key: ${data.details.apiKeySet ? '✅' : '❌'}<br>`;
                    html += `API Secret: ${data.details.apiSecretSet ? '✅' : '❌'}<br>`;
                    html += `채널 ID: ${data.details.pfIdSet ? '✅' : '❌'}<br>`;
                    html += `템플릿 ID: ${data.details.templateIdSet ? '✅' : '❌'}<br>`;
                    html += `발신번호: ${data.details.fromNumberSet ? '✅' : '❌'}<br>`;
                    html += `수신번호: ${data.details.adminPhonesSet ? '✅' : '❌'}`;
                    if (data.details.adminPhoneCount > 0) {
                        html += ` (${data.details.adminPhoneCount}개)`;
                    }
                    html += '</div>';

                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = '<div class="status-card error">❌ 설정 확인 실패</div>';
                    addLog('설정 확인 실패', 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-card error">❌ 오류: ${error.message}</div>`;
                addLog(`설정 확인 오류: ${error.message}`, 'error');
            }
        }

        async function sendTest() {
            const btn = document.getElementById('testBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '발송 중... <span class="spinner"></span>';

            const isUrgent = document.getElementById('urgentCheck').checked;

            try {
                addLog(`테스트 알림톡 발송 시작 (긴급: ${isUrgent ? '예' : '아니오'})`, 'info');

                const response = await fetch('/api/test/alimtalk', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ urgent: isUrgent })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    addLog('알림톡 발송 성공!', 'success');

                    if (data.results) {
                        data.results.forEach(result => {
                            if (result.success) {
                                addLog(`✅ ${result.phone} - ${result.type} 발송 완료`, 'success');
                            } else {
                                addLog(`❌ ${result.phone} - 발송 실패: ${result.error}`, 'error');
                            }
                        });
                    }

                    alert('테스트 알림톡이 발송되었습니다.\n등록된 관리자 번호로 카카오톡을 확인해주세요.');
                } else {
                    addLog(`발송 실패: ${data.error || '알 수 없는 오류'}`, 'error');
                    if (data.details) {
                        addLog(`상세: ${data.details}`, 'error');
                    }
                    alert(`발송 실패: ${data.error}\n${data.details || ''}`);
                }
            } catch (error) {
                addLog(`발송 오류: ${error.message}`, 'error');
                alert(`오류: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // 페이지 로드 시 자동으로 설정 확인
        window.onload = async function() {
            await checkConfig();
        };
    </script>
</body>
</html>
import{c as _}from"./vendor-data-BwGxWJIh.js";import{a as m,c as S,d as g,p as y}from"./index-DjkVa4fi.js";const D={getAllSchedules:async()=>(await m.get("/schedules")).data,getScheduleById:async a=>(await m.get(`/schedules/${a}`)).data,createSchedule:async a=>(await m.post("/schedules",{project:a.project,title:a.title,type:a.type||"other",phase:a.phase||"ê¸°íƒ€",startDate:a.startDate,endDate:a.endDate,allDay:a.allDay!==void 0?a.allDay:!0,assignedTo:a.assignedTo||[],description:a.description,location:a.location,priority:a.priority||"medium",progress:a.progress||0,isCompleted:a.isCompleted||!1,asRequestId:a.asRequestId,time:a.time})).data,updateSchedule:async(a,c)=>(await m.put(`/schedules/${a}`,c)).data,deleteSchedule:async a=>{await m.delete(`/schedules/${a}`)}},A={getAllProjects:async()=>(await m.get("/projects")).data,getProjectById:async a=>(await m.get(`/projects/${a}`)).data,createProject:async a=>{const c={name:a.name,client:typeof a.client=="string"?a.client:a.client.name,location:typeof a.location=="string"?a.location:a.location.address,status:a.status||"planning",manager:a.manager,description:a.description||""};if(a.startDate){const o=typeof a.startDate=="string"?new Date(a.startDate):a.startDate;c.startDate=o.toISOString().split("T")[0]}if(a.endDate){const o=typeof a.endDate=="string"?new Date(a.endDate):a.endDate;c.endDate=o.toISOString().split("T")[0]}return console.log("[projectService.createProject] Sending to backend:",c),(await m.post("/projects",c)).data},updateProject:async(a,c)=>{var o;const t={};if(c.name!==void 0&&(t.name=c.name),c.client!==void 0&&(t.client=typeof c.client=="string"?c.client:c.client.name),c.location!==void 0&&(t.location=typeof c.location=="string"?c.location:c.location.address),c.startDate!==void 0)if(typeof c.startDate=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(c.startDate))t.startDate=c.startDate;else{const e=typeof c.startDate=="string"?new Date(c.startDate):c.startDate;t.startDate=e.toISOString().split("T")[0]}if(c.endDate!==void 0)if(typeof c.endDate=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(c.endDate))t.endDate=c.endDate;else{const e=typeof c.endDate=="string"?new Date(c.endDate):c.endDate;t.endDate=e.toISOString().split("T")[0]}c.status!==void 0&&(t.status=c.status),c.manager!==void 0&&(t.manager=c.manager),c.description!==void 0&&(t.description=c.description),c.meetingNotes!==void 0&&(t.meetingNotes=c.meetingNotes),c.customerRequests!==void 0&&(t.customerRequests=c.customerRequests),c.entrancePassword!==void 0&&(t.entrancePassword=c.entrancePassword),c.sitePassword!==void 0&&(t.sitePassword=c.sitePassword),console.log("[projectService.updateProject] Sending to backend:",t);try{return(await m.put(`/projects/${a}`,t)).data}catch(e){const n=e;throw console.error("[projectService.updateProject] Error:",e),console.error("[projectService.updateProject] Error response:",(o=n.response)==null?void 0:o.data),e}},deleteProject:async a=>{await m.delete(`/projects/${a}`)}},w={getAllContractors:async()=>(await m.get("/contractors")).data,getContractorById:async a=>(await m.get(`/contractors/${a}`)).data,createContractor:async a=>(await m.post("/contractors",a)).data,updateContractor:async(a,c)=>(await m.put(`/contractors/${a}`,c)).data,deleteContractor:async a=>{await m.delete(`/contractors/${a}`)}},P={getAllConstructionPayments:async()=>(await m.get("/construction-payments")).data,getConstructionPaymentById:async a=>(await m.get(`/construction-payments/${a}`)).data,createConstructionPayment:async a=>(await m.post("/construction-payments",a)).data,updateConstructionPayment:async(a,c)=>(await m.put(`/construction-payments/${a}`,c)).data,deleteConstructionPayment:async a=>{await m.delete(`/construction-payments/${a}`)}},h={getAllRecords:async()=>(await m.get("/execution-records")).data,getRecordById:async a=>(await m.get(`/execution-records/${a}`)).data,createRecord:async a=>(console.log("[executionRecordService.createRecord] Creating:",a),(await m.post("/execution-records",a)).data),updateRecord:async(a,c)=>(await m.put(`/execution-records/${a}`,c)).data,deleteRecord:async a=>{await m.delete(`/execution-records/${a}`)}},b=_()(S((a,c)=>({projects:[],schedules:[],payments:[],contractors:[],constructionPayments:[],asRequests:[],executionRecords:[],setProjects:t=>a({projects:t}),addProject:t=>a(o=>{const e={id:t.id,project:t.name,client:t.client,totalAmount:t.contractAmount,vatType:"percentage",vatPercentage:100,vatAmount:0,payments:[]};return{projects:[t,...o.projects],constructionPayments:[e,...o.constructionPayments]}}),updateProject:(t,o)=>a(e=>({projects:e.projects.map(n=>n.id===t?{...n,...o}:n)})),deleteProject:t=>a(o=>({projects:o.projects.filter(e=>e.id!==t),constructionPayments:o.constructionPayments.filter(e=>e.id!==t)})),setSchedules:t=>a({schedules:t}),addSchedule:t=>a(o=>({schedules:[t,...o.schedules]})),updateSchedule:(t,o)=>a(e=>({schedules:e.schedules.map(n=>n.id===t?{...n,...o}:n)})),deleteSchedule:t=>a(o=>({schedules:o.schedules.filter(e=>e.id!==t)})),setPayments:t=>a({payments:t}),addPayment:t=>a(o=>({payments:[t,...o.payments]})),updatePayment:(t,o)=>a(e=>({payments:e.payments.map(n=>n.id===t?{...n,...o}:n)})),deletePayment:t=>a(o=>({payments:o.payments.filter(e=>e.id!==t)})),setContractors:t=>a({contractors:t}),addContractor:t=>a(o=>({contractors:[t,...o.contractors]})),updateContractor:(t,o)=>a(e=>({contractors:e.contractors.map(n=>n.id===t?{...n,...o}:n)})),deleteContractor:t=>a(o=>({contractors:o.contractors.filter(e=>e.id!==t)})),setConstructionPayments:t=>a({constructionPayments:t}),addConstructionPayment:t=>a(o=>({constructionPayments:[t,...o.constructionPayments]})),updateConstructionPayment:(t,o)=>a(e=>({constructionPayments:e.constructionPayments.map(n=>n.id===t?{...n,...o}:n)})),deleteConstructionPayment:t=>a(o=>({constructionPayments:o.constructionPayments.filter(e=>e.id!==t)})),setASRequests:t=>a({asRequests:t}),addASRequest:t=>a(o=>({asRequests:[t,...o.asRequests]})),updateASRequest:(t,o)=>a(e=>({asRequests:e.asRequests.map(n=>n.id===t?{...n,...o}:n)})),deleteASRequest:t=>a(o=>({asRequests:o.asRequests.filter(e=>e.id!==t)})),setExecutionRecords:t=>a({executionRecords:t}),addExecutionRecord:t=>{console.log("[dataStore] ì‹¤í–‰ë‚´ì—­ ì¶”ê°€:",t.id,t.itemName),a(o=>{const e=[t,...o.executionRecords];return console.log("[dataStore] ì´ ì‹¤í–‰ë‚´ì—­ ìˆ˜:",e.length),{executionRecords:e}})},updateExecutionRecord:(t,o)=>a(e=>({executionRecords:e.executionRecords.map(n=>n.id===t?{...n,...o}:n)})),deleteExecutionRecord:t=>a(o=>({executionRecords:o.executionRecords.filter(e=>e.id!==t)})),loadPaymentsFromAPI:async()=>{try{const t=await y.getAllPayments();console.log("[loadPaymentsFromAPI] Raw API response sample:",t[0]);const o=t.map(e=>({id:String(e.id),project:e.project_name,purpose:e.description,process:e.vendor_name,itemName:e.item_name||"",amount:e.amount,materialAmount:e.material_amount||0,laborAmount:e.labor_amount||0,originalMaterialAmount:e.original_material_amount||0,originalLaborAmount:e.original_labor_amount||0,applyTaxDeduction:e.apply_tax_deduction===1,includesVAT:e.includes_vat===1,quickText:e.quick_text||"",images:(()=>{if(!e.images)return[];if(Array.isArray(e.images))return e.images;try{const n=JSON.parse(e.images);return Array.isArray(n)?n:[]}catch(n){return console.error("ì´ë¯¸ì§€ íŒŒì‹± ì˜¤ë¥˜:",n),[]}})(),category:e.request_type,status:e.status,urgency:"normal",requestedBy:e.requester_name,requestDate:new Date(e.created_at),approvalDate:e.approved_at?new Date(e.approved_at):void 0,bankInfo:{accountHolder:e.account_holder||"",bankName:e.bank_name||"",accountNumber:e.account_number||""},attachments:[],notes:e.notes||""}));a({payments:o})}catch(t){throw console.error("Failed to load payments from API:",t),t}},addPaymentToAPI:async t=>{try{const e=c().projects.find(u=>u.name===t.project),s={projectId:e?e.id:t.project,purpose:t.purpose,process:t.process,itemName:t.itemName,amount:t.amount,category:t.category,urgency:t.urgency,requestedBy:t.requestedBy,bankInfo:t.bankInfo,notes:t.notes,attachments:[],materialAmount:t.materialAmount||0,laborAmount:t.laborAmount||0,originalMaterialAmount:t.originalMaterialAmount||0,originalLaborAmount:t.originalLaborAmount||0,applyTaxDeduction:t.applyTaxDeduction||!1,includesVAT:t.includesVAT||!1,quickText:t.quickText||"",images:t.images||[]};console.log("[addPaymentToAPI] Sending payment data:",s);const r=await y.createPayment(s),i=String(r.id),l={...t,id:i};return a(u=>({payments:[l,...u.payments]})),i}catch(o){throw console.error("Failed to add payment to API:",o),o}},updatePaymentInAPI:async(t,o)=>{try{if(o.status&&Object.keys(o).length===1)await y.updatePaymentStatus(t,o.status);else{let e=o.project;if(o.project){const s=c().projects.find(r=>r.name===o.project);e=s?s.id:o.project}await y.updatePayment(t,{projectId:e,purpose:o.purpose,process:o.process,itemName:o.itemName,amount:o.amount,materialAmount:o.materialAmount,laborAmount:o.laborAmount,originalMaterialAmount:o.originalMaterialAmount,originalLaborAmount:o.originalLaborAmount,category:o.category,urgency:o.urgency,bankInfo:o.bankInfo,notes:o.notes,requestDate:o.requestDate,includesVAT:o.includesVAT,applyTaxDeduction:o.applyTaxDeduction})}a(e=>({payments:e.payments.map(n=>n.id===t?{...n,...o}:n)}))}catch(e){throw console.error("Failed to update payment in API:",e),e}},deletePaymentFromAPI:async t=>{try{await y.deletePayment(t),a(o=>({payments:o.payments.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete payment from API:",o),o}},loadSchedulesFromAPI:async()=>{try{const t=await D.getAllSchedules();console.log("ðŸŸ£ LOAD SCHEDULES - Raw API response sample:",t[0]);const o=t.map(e=>{var s;console.log("ðŸŸ£ Processing schedule:",{id:e._id,title:e.title,assigneeNames:e.assigneeNames,assignedTo:e.assignedTo,assignedToType:typeof e.assignedTo,assignedToLength:Array.isArray(e.assignedTo)?e.assignedTo.length:"not array"});const n=Array.isArray(e.assigneeNames)?e.assigneeNames:e.assigneeNames?typeof e.assigneeNames=="string"?e.assigneeNames.split(",").map(r=>r.trim()):[e.assigneeNames]:((s=e.assignedTo)==null?void 0:s.map(r=>typeof r=="object"?r.name:r))||[];return console.log("ðŸŸ£ Final attendees:",n),{id:e._id,title:e.title,start:new Date(e.startDate),end:new Date(e.endDate),type:e.type,project:typeof e.project=="object"?e.project.name:e.project,location:e.location,attendees:n,description:e.description,time:e.time}});a({schedules:o})}catch(t){throw console.error("Failed to load schedules from API:",t),t}},addScheduleToAPI:async t=>{var o;try{console.log("ðŸš€ addScheduleToAPI - Input schedule:",{project:t.project,attendees:t.attendees,title:t.title});const e=await D.createSchedule({project:t.project||"",title:t.title,type:t.type,startDate:t.start,endDate:t.end,allDay:!t.time||t.time==="-",location:t.location,assignedTo:t.attendees||[],description:t.description,asRequestId:t.asRequestId,time:t.time});console.log("ðŸš€ addScheduleToAPI - API Response:",{id:e._id,assigneeNames:e.assigneeNames,assignedTo:e.assignedTo,project:e.project});const n=t.attendees||[];let s=e.assigneeNames||((o=e.assignedTo)==null?void 0:o.map(i=>typeof i=="object"?i.name:i))||[];n.length>0&&s.length>n.length&&(console.log("âš ï¸ Server added extra attendees, filtering to match request:",{requested:n,serverReturned:s}),s=n);const r={id:e._id,title:e.title,start:new Date(e.startDate),end:new Date(e.endDate),type:e.type,project:typeof e.project=="object"?e.project.name:e.project,location:e.location,attendees:s,description:e.description,time:e.time};console.log("ðŸš€ addScheduleToAPI - Final schedule attendees:",r.attendees),a(i=>({schedules:[r,...i.schedules]}))}catch(e){throw console.error("Failed to add schedule to API:",e),e}},updateScheduleInAPI:async(t,o)=>{var e,n,s;try{console.log("ðŸ“¤ updateScheduleInAPI called with:",{id:t,updatedSchedule:o});const r={};o.project!==void 0&&(r.project=o.project),o.title!==void 0&&(r.title=o.title),o.type!==void 0&&(r.type=o.type),o.start!==void 0&&(r.startDate=o.start),o.end!==void 0&&(r.endDate=o.end),o.location!==void 0&&(r.location=o.location),o.description!==void 0&&(r.description=o.description),o.attendees!==void 0&&(r.assignedTo=o.attendees),o.time!==void 0&&(r.time=o.time),console.log("ðŸ“¤ Sending update data:",r);const i=await D.updateSchedule(t,r);console.log("âœ… updateScheduleInAPI response:",i);const l={id:i._id,title:i.title,start:new Date(i.startDate),end:new Date(i.endDate),type:i.type,project:typeof i.project=="object"?i.project.name:i.project,location:i.location,attendees:i.assigneeNames||((e=i.assignedTo)==null?void 0:e.map(u=>typeof u=="object"?u.name:u))||[],description:i.description,time:i.time};a(u=>({schedules:u.schedules.map(p=>p.id===t?l:p)}))}catch(r){throw console.error("Failed to update schedule in API:",r),console.error("Error details:",{message:r instanceof Error?r.message:"Unknown error",response:r&&typeof r=="object"&&"response"in r?(n=r.response)==null?void 0:n.data:void 0,status:r&&typeof r=="object"&&"response"in r?(s=r.response)==null?void 0:s.status:void 0}),r}},deleteScheduleFromAPI:async t=>{try{await D.deleteSchedule(t),a(o=>({schedules:o.schedules.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete schedule from API:",o),o}},loadProjectsFromAPI:async()=>{try{const o=(await A.getAllProjects()).map(e=>{var n,s;return{id:e._id||e.id,name:e.name,client:typeof e.client=="object"?e.client.name:e.client||"ë¯¸ë“±ë¡",location:typeof e.location=="object"?e.location.address:e.location||e.address||"ë¯¸ë“±ë¡",status:e.status==="inProgress"?"in-progress":e.status==="onHold"?"on-hold":e.status,progress:e.progress||0,startDate:e.startDate||e.start_date?new Date(e.startDate||e.start_date):void 0,endDate:e.endDate||e.end_date?new Date(e.endDate||e.end_date):void 0,contractAmount:e.budget||e.contractAmount||0,spent:e.actualCost||e.spent||0,manager:e.manager||"ë¯¸ì§€ì •",team:[],description:e.description||"",meetingNotes:((n=e.meetingNotes)==null?void 0:n.map(r=>({id:r.id,content:r.content,date:new Date(r.date)})))||[],customerRequests:((s=e.customerRequests)==null?void 0:s.map(r=>({id:r.id,content:r.content,completed:r.completed,createdAt:new Date(r.createdAt)})))||[],entrancePassword:e.entrancePassword||"",sitePassword:e.sitePassword||""}});a({projects:o})}catch(t){throw console.error("Failed to load projects from API:",t),t}},addProjectToAPI:async t=>{var o,e;try{const n=await A.createProject({name:t.name,client:t.client,location:t.location,startDate:t.startDate,endDate:t.endDate,status:t.status,contractAmount:t.contractAmount,spent:t.spent,manager:t.manager,team:t.team,progress:t.progress,description:t.description}),s={id:n._id||n.id,name:n.name,client:typeof n.client=="object"?n.client.name:n.client||"ë¯¸ë“±ë¡",location:typeof n.location=="object"?n.location.address:n.location||n.address||"ë¯¸ë“±ë¡",status:n.status==="inProgress"?"in-progress":n.status==="onHold"?"on-hold":n.status,progress:n.progress||0,startDate:n.startDate||n.start_date?new Date(n.startDate||n.start_date):void 0,endDate:n.endDate||n.end_date?new Date(n.endDate||n.end_date):void 0,contractAmount:n.budget||n.contractAmount||0,spent:n.actualCost||n.spent||0,manager:n.manager||"ë¯¸ì§€ì •",team:[],description:n.description||"",meetingNotes:((o=n.meetingNotes)==null?void 0:o.map(r=>({id:r.id,content:r.content,date:new Date(r.date)})))||[],customerRequests:((e=n.customerRequests)==null?void 0:e.map(r=>({id:r.id,content:r.content,completed:r.completed,createdAt:new Date(r.createdAt)})))||[],entrancePassword:n.entrancePassword||"",sitePassword:n.sitePassword||""};a(r=>({projects:[s,...r.projects]}))}catch(n){throw console.error("Failed to add project to API:",n),n}},updateProjectInAPI:async(t,o)=>{var e,n;try{const s=await A.updateProject(t,o),r={id:s._id||s.id,name:s.name,client:typeof s.client=="object"?s.client.name:s.client||"ë¯¸ë“±ë¡",location:typeof s.location=="object"?s.location.address:s.location||s.address||"ë¯¸ë“±ë¡",status:s.status==="inProgress"?"in-progress":s.status==="onHold"?"on-hold":s.status,progress:s.progress||0,startDate:s.startDate||s.start_date?new Date(s.startDate||s.start_date):void 0,endDate:s.endDate||s.end_date?new Date(s.endDate||s.end_date):void 0,contractAmount:s.budget||s.contractAmount||0,spent:s.actualCost||s.spent||0,manager:s.manager||"ë¯¸ì§€ì •",team:[],description:s.description||"",meetingNotes:((e=s.meetingNotes)==null?void 0:e.map(i=>({id:i.id,content:i.content,date:new Date(i.date)})))||[],customerRequests:((n=s.customerRequests)==null?void 0:n.map(i=>({id:i.id,content:i.content,completed:i.completed,createdAt:new Date(i.createdAt)})))||[],entrancePassword:s.entrancePassword||"",sitePassword:s.sitePassword||""};a(i=>({projects:i.projects.map(l=>l.id===t?r:l)}))}catch(s){throw console.error("Failed to update project in API:",s),s}},deleteProjectFromAPI:async t=>{try{await A.deleteProject(t),a(o=>({projects:o.projects.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete project from API:",o),o}},loadContractorsFromAPI:async()=>{try{const o=(await w.getAllContractors()).map(e=>({id:e._id,rank:e.rank,companyName:e.companyName,name:e.name,process:e.process,contact:e.contact,accountNumber:e.accountNumber,notes:e.notes,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}));a({contractors:o})}catch(t){throw console.error("Failed to load contractors from API:",t),t}},addContractorToAPI:async t=>{try{const o=await w.createContractor({rank:t.rank,companyName:t.companyName,name:t.name,process:t.process,contact:t.contact,accountNumber:t.accountNumber,notes:t.notes}),e={id:o._id,rank:o.rank,companyName:o.companyName,name:o.name,process:o.process,contact:o.contact,accountNumber:o.accountNumber,notes:o.notes,createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt)};a(n=>({contractors:[e,...n.contractors]}))}catch(o){throw console.error("Failed to add contractor to API:",o),o}},updateContractorInAPI:async(t,o)=>{try{const e=await w.updateContractor(t,{rank:o.rank,companyName:o.companyName,name:o.name,process:o.process,contact:o.contact,accountNumber:o.accountNumber,notes:o.notes}),n={id:e._id,rank:e.rank,companyName:e.companyName,name:e.name,process:e.process,contact:e.contact,accountNumber:e.accountNumber,notes:e.notes,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};a(s=>({contractors:s.contractors.map(r=>r.id===t?n:r)}))}catch(e){throw console.error("Failed to update contractor in API:",e),e}},deleteContractorFromAPI:async t=>{try{await w.deleteContractor(t),a(o=>({contractors:o.contractors.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete contractor from API:",o),o}},loadConstructionPaymentsFromAPI:async()=>{try{const o=(await P.getAllConstructionPayments()).map(e=>{var s;let n;return e.expectedPaymentDates&&(n={contract:e.expectedPaymentDates.contract?new Date(e.expectedPaymentDates.contract):void 0,start:e.expectedPaymentDates.start?new Date(e.expectedPaymentDates.start):void 0,middle:e.expectedPaymentDates.middle?new Date(e.expectedPaymentDates.middle):void 0,final:e.expectedPaymentDates.final?new Date(e.expectedPaymentDates.final):void 0}),{id:e._id,project:e.project,client:e.client,totalAmount:e.totalAmount,vatType:e.vatType,vatPercentage:e.vatPercentage,vatAmount:e.vatAmount,expectedPaymentDates:n,payments:((s=e.payments)==null?void 0:s.map(r=>{var u;const i=r.date?new Date(r.date):new Date,l=isNaN(i.getTime())?new Date:i;return{type:r.type||((u=r.types)==null?void 0:u[0])||"ê³„ì•½ê¸ˆ",amount:r.amount,date:l,method:r.method,notes:r.notes}}))||[]}});a({constructionPayments:o})}catch(t){throw console.error("Failed to load construction payments from API:",t),t}},addConstructionPaymentToAPI:async t=>{var o;try{const e=await P.createConstructionPayment(t),n={id:e._id,project:e.project,client:e.client,totalAmount:e.totalAmount,vatType:e.vatType,vatPercentage:e.vatPercentage,vatAmount:e.vatAmount,payments:((o=e.payments)==null?void 0:o.map(s=>{var l;const r=s.date?new Date(s.date):new Date,i=isNaN(r.getTime())?new Date:r;return{type:s.type||((l=s.types)==null?void 0:l[0])||"ê³„ì•½ê¸ˆ",amount:s.amount,date:i,method:s.method,notes:s.notes}}))||[]};a(s=>({constructionPayments:[n,...s.constructionPayments]}))}catch(e){throw console.error("Failed to add construction payment to API:",e),e}},updateConstructionPaymentInAPI:async(t,o)=>{var e;try{const n=await P.updateConstructionPayment(t,o);let s;n.expectedPaymentDates&&(s={contract:n.expectedPaymentDates.contract?new Date(n.expectedPaymentDates.contract):void 0,start:n.expectedPaymentDates.start?new Date(n.expectedPaymentDates.start):void 0,middle:n.expectedPaymentDates.middle?new Date(n.expectedPaymentDates.middle):void 0,final:n.expectedPaymentDates.final?new Date(n.expectedPaymentDates.final):void 0});const r={id:n._id,project:n.project,client:n.client,totalAmount:n.totalAmount,vatType:n.vatType,vatPercentage:n.vatPercentage,vatAmount:n.vatAmount,expectedPaymentDates:s,payments:((e=n.payments)==null?void 0:e.map(i=>{var l;return{type:i.type||((l=i.types)==null?void 0:l[0])||"ê³„ì•½ê¸ˆ",amount:i.amount,date:new Date(i.date),method:i.method,notes:i.notes}}))||[]};a(i=>({constructionPayments:i.constructionPayments.map(l=>l.id===t?r:l)}))}catch(n){throw console.error("Failed to update construction payment in API:",n),n}},deleteConstructionPaymentFromAPI:async t=>{try{await P.deleteConstructionPayment(t),a(o=>({constructionPayments:o.constructionPayments.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete construction payment from API:",o),o}},loadASRequestsFromAPI:async()=>{try{const o=(await g.getAllASRequests()).map(e=>({id:e._id,project:e.project,client:e.client,requestDate:new Date(e.requestDate),siteAddress:e.siteAddress,entrancePassword:e.entrancePassword,description:e.description,scheduledVisitDate:e.scheduledVisitDate?new Date(e.scheduledVisitDate):void 0,scheduledVisitTime:e.scheduledVisitTime,assignedTo:e.assignedTo?Array.isArray(e.assignedTo)?e.assignedTo:[e.assignedTo]:[],completionDate:e.completionDate?new Date(e.completionDate):void 0,notes:e.notes,status:e.status||"pending"}));a({asRequests:o})}catch(t){throw console.error("Failed to load AS requests from API:",t),t}},addASRequestToAPI:async t=>{try{const o=await g.createASRequest(t),e={id:o._id,project:o.project,client:o.client,requestDate:new Date(o.requestDate),siteAddress:o.siteAddress,entrancePassword:o.entrancePassword,description:o.description,scheduledVisitDate:o.scheduledVisitDate?new Date(o.scheduledVisitDate):void 0,scheduledVisitTime:o.scheduledVisitTime,assignedTo:Array.isArray(o.assignedTo)?o.assignedTo:[],completionDate:o.completionDate?new Date(o.completionDate):void 0,notes:o.notes};return a(n=>({asRequests:[e,...n.asRequests]})),e}catch(o){throw console.error("Failed to add AS request to API:",o),o}},updateASRequestInAPI:async(t,o)=>{try{const e=await g.updateASRequest(t,o),n={id:e._id,project:e.project,client:e.client,requestDate:new Date(e.requestDate),siteAddress:e.siteAddress,entrancePassword:e.entrancePassword,description:e.description,scheduledVisitDate:e.scheduledVisitDate?new Date(e.scheduledVisitDate):void 0,scheduledVisitTime:e.scheduledVisitTime,assignedTo:Array.isArray(e.assignedTo)?e.assignedTo:[],completionDate:e.completionDate?new Date(e.completionDate):void 0,notes:e.notes,status:e.status||"pending"};a(s=>({asRequests:s.asRequests.map(r=>r.id===t?n:r)}))}catch(e){throw console.error("Failed to update AS request in API:",e),e}},deleteASRequestFromAPI:async t=>{try{await g.deleteASRequest(t),a(o=>({asRequests:o.asRequests.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete AS request from API:",o),o}},loadExecutionRecordsFromAPI:async()=>{try{const t=await h.getAllRecords();console.log("[loadExecutionRecordsFromAPI] Loaded",t.length,"records");const o=t.map(e=>({id:String(e.id),project:e.project_name,author:e.author||void 0,date:new Date(e.date),process:e.process||void 0,itemName:e.item_name,materialCost:e.material_cost||0,laborCost:e.labor_cost||0,vatAmount:e.vat_amount||0,totalAmount:e.total_amount||0,notes:e.notes||void 0,images:e.images||[],paymentId:e.payment_id?String(e.payment_id):void 0,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}));a({executionRecords:o})}catch(t){throw console.error("Failed to load execution records from API:",t),t}},addExecutionRecordToAPI:async t=>{try{console.log("[addExecutionRecordToAPI] Adding:",t.itemName);const o=await h.createRecord({project_name:t.project,author:t.author,date:t.date.toISOString().split("T")[0],process:t.process,item_name:t.itemName,material_cost:t.materialCost,labor_cost:t.laborCost,vat_amount:t.vatAmount,total_amount:t.totalAmount,notes:t.notes,payment_id:t.paymentId}),e={id:String(o.id),project:o.project_name,author:o.author||void 0,date:new Date(o.date),process:o.process||void 0,itemName:o.item_name,materialCost:o.material_cost||0,laborCost:o.labor_cost||0,vatAmount:o.vat_amount||0,totalAmount:o.total_amount||0,notes:o.notes||void 0,paymentId:o.payment_id?String(o.payment_id):void 0,createdAt:new Date(o.created_at),updatedAt:new Date(o.updated_at)};return a(n=>({executionRecords:[e,...n.executionRecords]})),console.log("[addExecutionRecordToAPI] Added with ID:",e.id),e}catch(o){throw console.error("Failed to add execution record to API:",o),o}},updateExecutionRecordInAPI:async(t,o)=>{try{let e;if(o.date){const n=o.date instanceof Date?o.date:new Date(o.date);isNaN(n.getTime())||(e=n.toISOString().split("T")[0])}await h.updateRecord(t,{project_name:o.project,author:o.author,date:e,process:o.process,item_name:o.itemName,material_cost:o.materialCost,labor_cost:o.laborCost,vat_amount:o.vatAmount,total_amount:o.totalAmount,notes:o.notes,payment_id:o.paymentId,images:o.images}),a(n=>({executionRecords:n.executionRecords.map(s=>s.id===t?{...s,...o,updatedAt:new Date}:s)}))}catch(e){throw console.error("Failed to update execution record in API:",e),e}},deleteExecutionRecordFromAPI:async t=>{try{await h.deleteRecord(t),a(o=>({executionRecords:o.executionRecords.filter(e=>e.id!==t)}))}catch(o){throw console.error("Failed to delete execution record from API:",o),o}}}),{name:"interior-management-storage",partialize:a=>({...a,payments:a.payments.map(c=>{const{images:t,...o}=c;return o}),executionRecords:a.executionRecords.map(c=>{const{images:t,...o}=c;return o})}),storage:{getItem:a=>{var i,l,u,p,v,j,f;const c=localStorage.getItem(a);if(!c)return null;const{state:t}=JSON.parse(c),o=((i=t.projects)==null?void 0:i.map(d=>({...d,startDate:d.startDate?new Date(d.startDate):void 0,endDate:d.endDate?new Date(d.endDate):void 0,contractAmount:d.contractAmount!==void 0?d.contractAmount:d.budget||0})))||[],e=((l=t.constructionPayments)==null?void 0:l.map(d=>{var I;return{...d,vatType:d.vatType||"percentage",vatPercentage:d.vatPercentage??100,vatAmount:d.vatAmount??0,payments:((I=d.payments)==null?void 0:I.map(R=>({...R,date:new Date(R.date)})))||[]}}))||[],n=new Set(e.map(d=>d.id)),s=o.filter(d=>!n.has(d.id)).map(d=>({id:d.id,project:d.name,client:d.client,totalAmount:d.contractAmount||0,vatType:"percentage",vatPercentage:100,vatAmount:0,payments:[]})),r=[...e,...s];return{state:{...t,projects:o,schedules:((u=t.schedules)==null?void 0:u.map(d=>({...d,start:new Date(d.start),end:new Date(d.end)})))||[],payments:((p=t.payments)==null?void 0:p.map(d=>({...d,requestDate:new Date(d.requestDate),approvalDate:d.approvalDate?new Date(d.approvalDate):void 0})))||[],contractors:((v=t.contractors)==null?void 0:v.map(d=>({...d,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt)})))||[],constructionPayments:r,asRequests:((j=t.asRequests)==null?void 0:j.map(d=>({...d,requestDate:new Date(d.requestDate),scheduledVisitDate:d.scheduledVisitDate?new Date(d.scheduledVisitDate):void 0,completionDate:d.completionDate?new Date(d.completionDate):void 0})))||[],executionRecords:((f=t.executionRecords)==null?void 0:f.map(d=>({...d,date:new Date(d.date),createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt)})))||[]}}},setItem:(a,c)=>{try{const t=JSON.stringify(c);localStorage.setItem(a,t)}catch(t){console.error("[dataStore] localStorage ì €ìž¥ ì‹¤íŒ¨:",t),t instanceof DOMException&&t.name==="QuotaExceededError"&&console.warn("[dataStore] localStorage ìš©ëŸ‰ ì´ˆê³¼ - ì¼ë¶€ ë°ì´í„° ì‚­ì œ í•„ìš”")}},removeItem:a=>localStorage.removeItem(a)}}));export{w as c,b as u};

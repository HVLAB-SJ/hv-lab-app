import{c as f}from"./vendor-data-BwGxWJIh.js";import{a as m,c as x,d as A,e as g,p as y}from"./index-zC2PcKP2.js";const D={getAllSchedules:async()=>(await m.get("/schedules")).data,getScheduleById:async n=>(await m.get(`/schedules/${n}`)).data,createSchedule:async n=>(await m.post("/schedules",{project:n.project,title:n.title,type:n.type||"other",phase:n.phase||"ê¸°íƒ€",startDate:n.startDate,endDate:n.endDate,allDay:n.allDay!==void 0?n.allDay:!0,assignedTo:n.assignedTo||[],description:n.description,location:n.location,priority:n.priority||"medium",progress:n.progress||0,isCompleted:n.isCompleted||!1,asRequestId:n.asRequestId,time:n.time})).data,updateSchedule:async(n,d)=>(await m.put(`/schedules/${n}`,d)).data,deleteSchedule:async n=>{await m.delete(`/schedules/${n}`)}},w={getAllContractors:async()=>(await m.get("/contractors")).data,getContractorById:async n=>(await m.get(`/contractors/${n}`)).data,createContractor:async n=>(await m.post("/contractors",n)).data,updateContractor:async(n,d)=>(await m.put(`/contractors/${n}`,d)).data,deleteContractor:async n=>{await m.delete(`/contractors/${n}`)}},P={getAllConstructionPayments:async()=>(await m.get("/construction-payments")).data,getConstructionPaymentById:async n=>(await m.get(`/construction-payments/${n}`)).data,createConstructionPayment:async n=>(await m.post("/construction-payments",n)).data,updateConstructionPayment:async(n,d)=>(await m.put(`/construction-payments/${n}`,d)).data,deleteConstructionPayment:async n=>{await m.delete(`/construction-payments/${n}`)}},h={getAllRecords:async()=>(await m.get("/execution-records")).data,getRecordById:async n=>(await m.get(`/execution-records/${n}`)).data,createRecord:async n=>(console.log("[executionRecordService.createRecord] Creating:",n),(await m.post("/execution-records",n)).data),updateRecord:async(n,d)=>(await m.put(`/execution-records/${n}`,d)).data,deleteRecord:async n=>{await m.delete(`/execution-records/${n}`)}},N=f()(x((n,d)=>({projects:[],schedules:[],payments:[],contractors:[],constructionPayments:[],asRequests:[],executionRecords:[],setProjects:a=>n({projects:a}),addProject:a=>n(t=>{const e={id:a.id,project:a.name,client:a.client,totalAmount:a.contractAmount,vatType:"percentage",vatPercentage:100,vatAmount:0,payments:[]};return{projects:[a,...t.projects],constructionPayments:[e,...t.constructionPayments]}}),updateProject:(a,t)=>n(e=>({projects:e.projects.map(o=>o.id===a?{...o,...t}:o)})),deleteProject:a=>n(t=>({projects:t.projects.filter(e=>e.id!==a),constructionPayments:t.constructionPayments.filter(e=>e.id!==a)})),setSchedules:a=>n({schedules:a}),addSchedule:a=>n(t=>({schedules:[a,...t.schedules]})),updateSchedule:(a,t)=>n(e=>({schedules:e.schedules.map(o=>o.id===a?{...o,...t}:o)})),deleteSchedule:a=>n(t=>({schedules:t.schedules.filter(e=>e.id!==a)})),setPayments:a=>n({payments:a}),addPayment:a=>n(t=>({payments:[a,...t.payments]})),updatePayment:(a,t)=>n(e=>({payments:e.payments.map(o=>o.id===a?{...o,...t}:o)})),deletePayment:a=>n(t=>({payments:t.payments.filter(e=>e.id!==a)})),setContractors:a=>n({contractors:a}),addContractor:a=>n(t=>({contractors:[a,...t.contractors]})),updateContractor:(a,t)=>n(e=>({contractors:e.contractors.map(o=>o.id===a?{...o,...t}:o)})),deleteContractor:a=>n(t=>({contractors:t.contractors.filter(e=>e.id!==a)})),setConstructionPayments:a=>n({constructionPayments:a}),addConstructionPayment:a=>n(t=>({constructionPayments:[a,...t.constructionPayments]})),updateConstructionPayment:(a,t)=>n(e=>({constructionPayments:e.constructionPayments.map(o=>o.id===a?{...o,...t}:o)})),deleteConstructionPayment:a=>n(t=>({constructionPayments:t.constructionPayments.filter(e=>e.id!==a)})),setASRequests:a=>n({asRequests:a}),addASRequest:a=>n(t=>({asRequests:[a,...t.asRequests]})),updateASRequest:(a,t)=>n(e=>({asRequests:e.asRequests.map(o=>o.id===a?{...o,...t}:o)})),deleteASRequest:a=>n(t=>({asRequests:t.asRequests.filter(e=>e.id!==a)})),setExecutionRecords:a=>n({executionRecords:a}),addExecutionRecord:a=>{console.log("[dataStore] ì‹¤í–‰ë‚´ì—­ ì¶”ê°€:",a.id,a.itemName),n(t=>{const e=[a,...t.executionRecords];return console.log("[dataStore] ì´ ì‹¤í–‰ë‚´ì—­ ìˆ˜:",e.length),{executionRecords:e}})},updateExecutionRecord:(a,t)=>n(e=>({executionRecords:e.executionRecords.map(o=>o.id===a?{...o,...t}:o)})),deleteExecutionRecord:a=>n(t=>({executionRecords:t.executionRecords.filter(e=>e.id!==a)})),loadPaymentsFromAPI:async()=>{try{const a=await y.getAllPayments();console.log("[loadPaymentsFromAPI] Raw API response sample:",a[0]);const t=a.map(e=>({id:String(e.id),project:e.project_name,purpose:e.description,process:e.vendor_name,itemName:e.item_name||"",amount:e.amount,materialAmount:e.material_amount||0,laborAmount:e.labor_amount||0,originalMaterialAmount:e.original_material_amount||0,originalLaborAmount:e.original_labor_amount||0,applyTaxDeduction:e.apply_tax_deduction===1,includesVAT:e.includes_vat===1,quickText:e.quick_text||"",images:(()=>{if(!e.images)return[];if(Array.isArray(e.images))return e.images;try{const o=JSON.parse(e.images);return Array.isArray(o)?o:[]}catch(o){return console.error("ì´ë¯¸ì§€ íŒŒì‹± ì˜¤ë¥˜:",o),[]}})(),category:e.request_type,status:e.status,urgency:"normal",requestedBy:e.requester_name,requestDate:new Date(e.created_at),approvalDate:e.approved_at?new Date(e.approved_at):void 0,bankInfo:{accountHolder:e.account_holder||"",bankName:e.bank_name||"",accountNumber:e.account_number||""},attachments:[],notes:e.notes||"",completionDate:e.paid_at?new Date(e.paid_at):void 0}));n({payments:t})}catch(a){throw console.error("Failed to load payments from API:",a),a}},addPaymentToAPI:async a=>{try{const e=d().projects.find(u=>u.name===a.project),s={projectId:e?e.id:a.project,purpose:a.purpose,process:a.process,itemName:a.itemName,amount:a.amount,category:a.category,urgency:a.urgency,requestedBy:a.requestedBy,bankInfo:a.bankInfo,notes:a.notes,attachments:[],materialAmount:a.materialAmount||0,laborAmount:a.laborAmount||0,originalMaterialAmount:a.originalMaterialAmount||0,originalLaborAmount:a.originalLaborAmount||0,applyTaxDeduction:a.applyTaxDeduction||!1,includesVAT:a.includesVAT||!1,quickText:a.quickText||"",images:a.images||[]};console.log("[addPaymentToAPI] Sending payment data:",s);const r=await y.createPayment(s),c=String(r.id),l={...a,id:c};return n(u=>({payments:[l,...u.payments]})),c}catch(t){throw console.error("Failed to add payment to API:",t),t}},updatePaymentInAPI:async(a,t)=>{try{if(t.status&&Object.keys(t).length===1)await y.updatePaymentStatus(a,t.status);else{let e=t.project;if(t.project){const s=d().projects.find(r=>r.name===t.project);e=s?s.id:t.project}await y.updatePayment(a,{projectId:e,purpose:t.purpose,process:t.process,itemName:t.itemName,amount:t.amount,materialAmount:t.materialAmount,laborAmount:t.laborAmount,originalMaterialAmount:t.originalMaterialAmount,originalLaborAmount:t.originalLaborAmount,category:t.category,urgency:t.urgency,bankInfo:t.bankInfo,notes:t.notes,requestDate:t.requestDate,includesVAT:t.includesVAT,applyTaxDeduction:t.applyTaxDeduction})}n(e=>({payments:e.payments.map(o=>o.id===a?{...o,...t}:o)}))}catch(e){throw console.error("Failed to update payment in API:",e),e}},deletePaymentFromAPI:async a=>{try{await y.deletePayment(a),n(t=>({payments:t.payments.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete payment from API:",t),t}},loadSchedulesFromAPI:async()=>{try{const a=await D.getAllSchedules();console.log("ðŸŸ£ LOAD SCHEDULES - Raw API response sample:",a[0]);const t=a.map(e=>{var s;console.log("ðŸŸ£ Processing schedule:",{id:e._id,title:e.title,assigneeNames:e.assigneeNames,assignedTo:e.assignedTo,assignedToType:typeof e.assignedTo,assignedToLength:Array.isArray(e.assignedTo)?e.assignedTo.length:"not array"});const o=Array.isArray(e.assigneeNames)?e.assigneeNames:e.assigneeNames?typeof e.assigneeNames=="string"?e.assigneeNames.split(",").map(r=>r.trim()):[e.assigneeNames]:((s=e.assignedTo)==null?void 0:s.map(r=>typeof r=="object"?r.name:r))||[];return console.log("ðŸŸ£ Final attendees:",o),{id:e._id,title:e.title,start:new Date(e.startDate),end:new Date(e.endDate),type:e.type,project:typeof e.project=="object"?e.project.name:e.project,location:e.location,attendees:o,description:e.description,time:e.time}});n({schedules:t})}catch(a){throw console.error("Failed to load schedules from API:",a),a}},addScheduleToAPI:async a=>{var t;try{console.log("ðŸš€ addScheduleToAPI - Input schedule:",{project:a.project,attendees:a.attendees,title:a.title});const e=await D.createSchedule({project:a.project||"",title:a.title,type:a.type,startDate:a.start,endDate:a.end,allDay:!a.time||a.time==="-",location:a.location,assignedTo:a.attendees||[],description:a.description,asRequestId:a.asRequestId,time:a.time});console.log("ðŸš€ addScheduleToAPI - API Response:",{id:e._id,assigneeNames:e.assigneeNames,assignedTo:e.assignedTo,project:e.project});const o=a.attendees||[];let s=e.assigneeNames||((t=e.assignedTo)==null?void 0:t.map(c=>typeof c=="object"?c.name:c))||[];o.length>0&&s.length>o.length&&(console.log("âš ï¸ Server added extra attendees, filtering to match request:",{requested:o,serverReturned:s}),s=o);const r={id:e._id,title:e.title,start:new Date(e.startDate),end:new Date(e.endDate),type:e.type,project:typeof e.project=="object"?e.project.name:e.project,location:e.location,attendees:s,description:e.description,time:e.time};console.log("ðŸš€ addScheduleToAPI - Final schedule attendees:",r.attendees),n(c=>({schedules:[r,...c.schedules]}))}catch(e){throw console.error("Failed to add schedule to API:",e),e}},updateScheduleInAPI:async(a,t)=>{var e,o,s;try{console.log("ðŸ“¤ updateScheduleInAPI called with:",{id:a,updatedSchedule:t});const r={};t.project!==void 0&&(r.project=t.project),t.title!==void 0&&(r.title=t.title),t.type!==void 0&&(r.type=t.type),t.start!==void 0&&(r.startDate=t.start),t.end!==void 0&&(r.endDate=t.end),t.location!==void 0&&(r.location=t.location),t.description!==void 0&&(r.description=t.description),t.attendees!==void 0&&(r.assignedTo=t.attendees),t.time!==void 0&&(r.time=t.time),console.log("ðŸ“¤ Sending update data:",r);const c=await D.updateSchedule(a,r);console.log("âœ… updateScheduleInAPI response:",c);const l={id:c._id,title:c.title,start:new Date(c.startDate),end:new Date(c.endDate),type:c.type,project:typeof c.project=="object"?c.project.name:c.project,location:c.location,attendees:c.assigneeNames||((e=c.assignedTo)==null?void 0:e.map(u=>typeof u=="object"?u.name:u))||[],description:c.description,time:c.time};n(u=>({schedules:u.schedules.map(p=>p.id===a?l:p)}))}catch(r){throw console.error("Failed to update schedule in API:",r),console.error("Error details:",{message:r instanceof Error?r.message:"Unknown error",response:r&&typeof r=="object"&&"response"in r?(o=r.response)==null?void 0:o.data:void 0,status:r&&typeof r=="object"&&"response"in r?(s=r.response)==null?void 0:s.status:void 0}),r}},deleteScheduleFromAPI:async a=>{try{await D.deleteSchedule(a),n(t=>({schedules:t.schedules.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete schedule from API:",t),t}},loadProjectsFromAPI:async()=>{try{const t=(await g.getAllProjects()).map(e=>{var o,s;return{id:e._id||e.id,name:e.name,client:typeof e.client=="object"?e.client.name:e.client||"ë¯¸ë“±ë¡",location:typeof e.location=="object"?e.location.address:e.location||e.address||"ë¯¸ë“±ë¡",status:e.status==="inProgress"?"in-progress":e.status==="onHold"?"on-hold":e.status,progress:e.progress||0,startDate:e.startDate||e.start_date?new Date(e.startDate||e.start_date):void 0,endDate:e.endDate||e.end_date?new Date(e.endDate||e.end_date):void 0,contractAmount:e.budget||e.contractAmount||0,spent:e.actualCost||e.spent||0,manager:e.manager||"ë¯¸ì§€ì •",team:[],description:e.description||"",meetingNotes:((o=e.meetingNotes)==null?void 0:o.map(r=>({id:r.id,content:r.content,date:new Date(r.date)})))||[],customerRequests:((s=e.customerRequests)==null?void 0:s.map(r=>({id:r.id,content:r.content,completed:r.completed,createdAt:new Date(r.createdAt)})))||[],entrancePassword:e.entrancePassword||"",sitePassword:e.sitePassword||""}});n({projects:t})}catch(a){throw console.error("Failed to load projects from API:",a),a}},addProjectToAPI:async a=>{var t,e;try{const o=await g.createProject({name:a.name,client:a.client,location:a.location,startDate:a.startDate,endDate:a.endDate,status:a.status,contractAmount:a.contractAmount,spent:a.spent,manager:a.manager,team:a.team,progress:a.progress,description:a.description}),s={id:o._id||o.id,name:o.name,client:typeof o.client=="object"?o.client.name:o.client||"ë¯¸ë“±ë¡",location:typeof o.location=="object"?o.location.address:o.location||o.address||"ë¯¸ë“±ë¡",status:o.status==="inProgress"?"in-progress":o.status==="onHold"?"on-hold":o.status,progress:o.progress||0,startDate:o.startDate||o.start_date?new Date(o.startDate||o.start_date):void 0,endDate:o.endDate||o.end_date?new Date(o.endDate||o.end_date):void 0,contractAmount:o.budget||o.contractAmount||0,spent:o.actualCost||o.spent||0,manager:o.manager||"ë¯¸ì§€ì •",team:[],description:o.description||"",meetingNotes:((t=o.meetingNotes)==null?void 0:t.map(r=>({id:r.id,content:r.content,date:new Date(r.date)})))||[],customerRequests:((e=o.customerRequests)==null?void 0:e.map(r=>({id:r.id,content:r.content,completed:r.completed,createdAt:new Date(r.createdAt)})))||[],entrancePassword:o.entrancePassword||"",sitePassword:o.sitePassword||""};n(r=>({projects:[s,...r.projects]}))}catch(o){throw console.error("Failed to add project to API:",o),o}},updateProjectInAPI:async(a,t)=>{var e,o;try{const s=await g.updateProject(a,t),r={id:s._id||s.id,name:s.name,client:typeof s.client=="object"?s.client.name:s.client||"ë¯¸ë“±ë¡",location:typeof s.location=="object"?s.location.address:s.location||s.address||"ë¯¸ë“±ë¡",status:s.status==="inProgress"?"in-progress":s.status==="onHold"?"on-hold":s.status,progress:s.progress||0,startDate:s.startDate||s.start_date?new Date(s.startDate||s.start_date):void 0,endDate:s.endDate||s.end_date?new Date(s.endDate||s.end_date):void 0,contractAmount:s.budget||s.contractAmount||0,spent:s.actualCost||s.spent||0,manager:s.manager||"ë¯¸ì§€ì •",team:[],description:s.description||"",meetingNotes:((e=s.meetingNotes)==null?void 0:e.map(c=>({id:c.id,content:c.content,date:new Date(c.date)})))||[],customerRequests:((o=s.customerRequests)==null?void 0:o.map(c=>({id:c.id,content:c.content,completed:c.completed,createdAt:new Date(c.createdAt)})))||[],entrancePassword:s.entrancePassword||"",sitePassword:s.sitePassword||""};n(c=>({projects:c.projects.map(l=>l.id===a?r:l)}))}catch(s){throw console.error("Failed to update project in API:",s),s}},deleteProjectFromAPI:async a=>{try{await g.deleteProject(a),n(t=>({projects:t.projects.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete project from API:",t),t}},loadContractorsFromAPI:async()=>{try{const t=(await w.getAllContractors()).map(e=>({id:e._id,rank:e.rank,companyName:e.companyName,name:e.name,process:e.process,contact:e.contact,accountNumber:e.accountNumber,notes:e.notes,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}));n({contractors:t})}catch(a){throw console.error("Failed to load contractors from API:",a),a}},addContractorToAPI:async a=>{try{const t=await w.createContractor({rank:a.rank,companyName:a.companyName,name:a.name,process:a.process,contact:a.contact,accountNumber:a.accountNumber,notes:a.notes}),e={id:t._id,rank:t.rank,companyName:t.companyName,name:t.name,process:t.process,contact:t.contact,accountNumber:t.accountNumber,notes:t.notes,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)};n(o=>({contractors:[e,...o.contractors]}))}catch(t){throw console.error("Failed to add contractor to API:",t),t}},updateContractorInAPI:async(a,t)=>{try{const e=await w.updateContractor(a,{rank:t.rank,companyName:t.companyName,name:t.name,process:t.process,contact:t.contact,accountNumber:t.accountNumber,notes:t.notes}),o={id:e._id,rank:e.rank,companyName:e.companyName,name:e.name,process:e.process,contact:e.contact,accountNumber:e.accountNumber,notes:e.notes,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};n(s=>({contractors:s.contractors.map(r=>r.id===a?o:r)}))}catch(e){throw console.error("Failed to update contractor in API:",e),e}},deleteContractorFromAPI:async a=>{try{await w.deleteContractor(a),n(t=>({contractors:t.contractors.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete contractor from API:",t),t}},loadConstructionPaymentsFromAPI:async()=>{try{const t=(await P.getAllConstructionPayments()).map(e=>{var s;let o;return e.expectedPaymentDates&&(o={contract:e.expectedPaymentDates.contract?new Date(e.expectedPaymentDates.contract):void 0,start:e.expectedPaymentDates.start?new Date(e.expectedPaymentDates.start):void 0,middle:e.expectedPaymentDates.middle?new Date(e.expectedPaymentDates.middle):void 0,final:e.expectedPaymentDates.final?new Date(e.expectedPaymentDates.final):void 0}),{id:e._id,project:e.project,client:e.client,totalAmount:e.totalAmount,vatType:e.vatType,vatPercentage:e.vatPercentage,vatAmount:e.vatAmount,expectedPaymentDates:o,payments:((s=e.payments)==null?void 0:s.map(r=>{var u;const c=r.date?new Date(r.date):new Date,l=isNaN(c.getTime())?new Date:c;return{type:r.type||((u=r.types)==null?void 0:u[0])||"ê³„ì•½ê¸ˆ",amount:r.amount,date:l,method:r.method,notes:r.notes}}))||[]}});n({constructionPayments:t})}catch(a){throw console.error("Failed to load construction payments from API:",a),a}},addConstructionPaymentToAPI:async a=>{var t;try{const e=await P.createConstructionPayment(a),o={id:e._id,project:e.project,client:e.client,totalAmount:e.totalAmount,vatType:e.vatType,vatPercentage:e.vatPercentage,vatAmount:e.vatAmount,payments:((t=e.payments)==null?void 0:t.map(s=>{var l;const r=s.date?new Date(s.date):new Date,c=isNaN(r.getTime())?new Date:r;return{type:s.type||((l=s.types)==null?void 0:l[0])||"ê³„ì•½ê¸ˆ",amount:s.amount,date:c,method:s.method,notes:s.notes}}))||[]};n(s=>({constructionPayments:[o,...s.constructionPayments]}))}catch(e){throw console.error("Failed to add construction payment to API:",e),e}},updateConstructionPaymentInAPI:async(a,t)=>{var e;try{const o=await P.updateConstructionPayment(a,t);let s;o.expectedPaymentDates&&(s={contract:o.expectedPaymentDates.contract?new Date(o.expectedPaymentDates.contract):void 0,start:o.expectedPaymentDates.start?new Date(o.expectedPaymentDates.start):void 0,middle:o.expectedPaymentDates.middle?new Date(o.expectedPaymentDates.middle):void 0,final:o.expectedPaymentDates.final?new Date(o.expectedPaymentDates.final):void 0});const r={id:o._id,project:o.project,client:o.client,totalAmount:o.totalAmount,vatType:o.vatType,vatPercentage:o.vatPercentage,vatAmount:o.vatAmount,expectedPaymentDates:s,payments:((e=o.payments)==null?void 0:e.map(c=>{var l;return{type:c.type||((l=c.types)==null?void 0:l[0])||"ê³„ì•½ê¸ˆ",amount:c.amount,date:new Date(c.date),method:c.method,notes:c.notes}}))||[]};n(c=>({constructionPayments:c.constructionPayments.map(l=>l.id===a?r:l)}))}catch(o){throw console.error("Failed to update construction payment in API:",o),o}},deleteConstructionPaymentFromAPI:async a=>{try{await P.deleteConstructionPayment(a),n(t=>({constructionPayments:t.constructionPayments.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete construction payment from API:",t),t}},loadASRequestsFromAPI:async()=>{try{const t=(await A.getAllASRequests()).map(e=>({id:e._id,project:e.project,client:e.client,requestDate:new Date(e.requestDate),siteAddress:e.siteAddress,entrancePassword:e.entrancePassword,description:e.description,scheduledVisitDate:e.scheduledVisitDate?new Date(e.scheduledVisitDate):void 0,scheduledVisitTime:e.scheduledVisitTime,assignedTo:e.assignedTo?Array.isArray(e.assignedTo)?e.assignedTo:[e.assignedTo]:[],completionDate:e.completionDate?new Date(e.completionDate):void 0,notes:e.notes,status:e.status||"pending"}));n({asRequests:t})}catch(a){throw console.error("Failed to load AS requests from API:",a),a}},addASRequestToAPI:async a=>{try{const t=await A.createASRequest(a),e={id:t._id,project:t.project,client:t.client,requestDate:new Date(t.requestDate),siteAddress:t.siteAddress,entrancePassword:t.entrancePassword,description:t.description,scheduledVisitDate:t.scheduledVisitDate?new Date(t.scheduledVisitDate):void 0,scheduledVisitTime:t.scheduledVisitTime,assignedTo:Array.isArray(t.assignedTo)?t.assignedTo:[],completionDate:t.completionDate?new Date(t.completionDate):void 0,notes:t.notes};return n(o=>({asRequests:[e,...o.asRequests]})),e}catch(t){throw console.error("Failed to add AS request to API:",t),t}},updateASRequestInAPI:async(a,t)=>{try{const e=await A.updateASRequest(a,t),o={id:e._id,project:e.project,client:e.client,requestDate:new Date(e.requestDate),siteAddress:e.siteAddress,entrancePassword:e.entrancePassword,description:e.description,scheduledVisitDate:e.scheduledVisitDate?new Date(e.scheduledVisitDate):void 0,scheduledVisitTime:e.scheduledVisitTime,assignedTo:Array.isArray(e.assignedTo)?e.assignedTo:[],completionDate:e.completionDate?new Date(e.completionDate):void 0,notes:e.notes,status:e.status||"pending"};n(s=>({asRequests:s.asRequests.map(r=>r.id===a?o:r)}))}catch(e){throw console.error("Failed to update AS request in API:",e),e}},deleteASRequestFromAPI:async a=>{try{await A.deleteASRequest(a),n(t=>({asRequests:t.asRequests.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete AS request from API:",t),t}},loadExecutionRecordsFromAPI:async()=>{try{const a=await h.getAllRecords();console.log("[loadExecutionRecordsFromAPI] Loaded",a.length,"records");const t=a.map(e=>({id:String(e.id),project:e.project_name,author:e.author||void 0,date:new Date(e.date),process:e.process||void 0,itemName:e.item_name,materialCost:e.material_cost||0,laborCost:e.labor_cost||0,vatAmount:e.vat_amount||0,totalAmount:e.total_amount||0,notes:e.notes||void 0,images:e.images||[],paymentId:e.payment_id?String(e.payment_id):void 0,includesTaxDeduction:e.includes_tax_deduction===1,includesVat:e.includes_vat===1,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}));n({executionRecords:t})}catch(a){throw console.error("Failed to load execution records from API:",a),a}},addExecutionRecordToAPI:async a=>{try{console.log("[addExecutionRecordToAPI] Adding:",a.itemName,"includesTaxDeduction:",a.includesTaxDeduction,"includesVat:",a.includesVat);const t=await h.createRecord({project_name:a.project,author:a.author,date:a.date.toISOString().split("T")[0],process:a.process,item_name:a.itemName,material_cost:a.materialCost,labor_cost:a.laborCost,vat_amount:a.vatAmount,total_amount:a.totalAmount,notes:a.notes,payment_id:a.paymentId,includes_tax_deduction:a.includesTaxDeduction,includes_vat:a.includesVat}),e={id:String(t.id),project:t.project_name,author:t.author||void 0,date:new Date(t.date),process:t.process||void 0,itemName:t.item_name,materialCost:t.material_cost||0,laborCost:t.labor_cost||0,vatAmount:t.vat_amount||0,totalAmount:t.total_amount||0,notes:t.notes||void 0,paymentId:t.payment_id?String(t.payment_id):void 0,includesTaxDeduction:t.includes_tax_deduction===1,includesVat:t.includes_vat===1,createdAt:new Date(t.created_at),updatedAt:new Date(t.updated_at)};return console.log("[addExecutionRecordToAPI] newRecord includesVat:",e.includesVat,"from API:",t.includes_vat),n(o=>({executionRecords:[e,...o.executionRecords]})),console.log("[addExecutionRecordToAPI] Added with ID:",e.id),e}catch(t){throw console.error("Failed to add execution record to API:",t),t}},updateExecutionRecordInAPI:async(a,t)=>{console.log("[updateExecutionRecordInAPI] Called with id:",a,"record:",t);try{let e;if(t.date){const o=t.date instanceof Date?t.date:new Date(t.date);console.log("[updateExecutionRecordInAPI] Date conversion:",{original:t.date,converted:o,isValid:!isNaN(o.getTime())}),isNaN(o.getTime())||(e=o.toISOString().split("T")[0])}console.log("[updateExecutionRecordInAPI] Calling API with dateStr:",e,"includesTaxDeduction:",t.includesTaxDeduction,"includesVat:",t.includesVat),await h.updateRecord(a,{project_name:t.project,author:t.author,date:e,process:t.process,item_name:t.itemName,material_cost:t.materialCost,labor_cost:t.laborCost,vat_amount:t.vatAmount,total_amount:t.totalAmount,notes:t.notes,payment_id:t.paymentId,images:t.images,includes_tax_deduction:t.includesTaxDeduction,includes_vat:t.includesVat}),n(o=>({executionRecords:o.executionRecords.map(s=>s.id===a?{...s,...t,updatedAt:new Date}:s)}))}catch(e){throw console.error("Failed to update execution record in API:",e),e}},deleteExecutionRecordFromAPI:async a=>{try{await h.deleteRecord(a),n(t=>({executionRecords:t.executionRecords.filter(e=>e.id!==a)}))}catch(t){throw console.error("Failed to delete execution record from API:",t),t}}}),{name:"interior-management-storage",partialize:n=>({...n,payments:n.payments.map(d=>{const{images:a,...t}=d;return t}),executionRecords:n.executionRecords.map(d=>{const{images:a,...t}=d;return t})}),storage:{getItem:n=>{var c,l,u,p,I,v,_;const d=localStorage.getItem(n);if(!d)return null;const{state:a}=JSON.parse(d),t=((c=a.projects)==null?void 0:c.map(i=>({...i,startDate:i.startDate?new Date(i.startDate):void 0,endDate:i.endDate?new Date(i.endDate):void 0,contractAmount:i.contractAmount!==void 0?i.contractAmount:i.budget||0})))||[],e=((l=a.constructionPayments)==null?void 0:l.map(i=>{var R;return{...i,vatType:i.vatType||"percentage",vatPercentage:i.vatPercentage??100,vatAmount:i.vatAmount??0,payments:((R=i.payments)==null?void 0:R.map(j=>({...j,date:new Date(j.date)})))||[]}}))||[],o=new Set(e.map(i=>i.id)),s=t.filter(i=>!o.has(i.id)).map(i=>({id:i.id,project:i.name,client:i.client,totalAmount:i.contractAmount||0,vatType:"percentage",vatPercentage:100,vatAmount:0,payments:[]})),r=[...e,...s];return{state:{...a,projects:t,schedules:((u=a.schedules)==null?void 0:u.map(i=>({...i,start:new Date(i.start),end:new Date(i.end)})))||[],payments:((p=a.payments)==null?void 0:p.map(i=>({...i,requestDate:new Date(i.requestDate),approvalDate:i.approvalDate?new Date(i.approvalDate):void 0})))||[],contractors:((I=a.contractors)==null?void 0:I.map(i=>({...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)})))||[],constructionPayments:r,asRequests:((v=a.asRequests)==null?void 0:v.map(i=>({...i,requestDate:new Date(i.requestDate),scheduledVisitDate:i.scheduledVisitDate?new Date(i.scheduledVisitDate):void 0,completionDate:i.completionDate?new Date(i.completionDate):void 0})))||[],executionRecords:((_=a.executionRecords)==null?void 0:_.map(i=>({...i,date:new Date(i.date),createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)})))||[]}}},setItem:(n,d)=>{try{const a=JSON.stringify(d);localStorage.setItem(n,a)}catch(a){console.error("[dataStore] localStorage ì €ìž¥ ì‹¤íŒ¨:",a),a instanceof DOMException&&a.name==="QuotaExceededError"&&console.warn("[dataStore] localStorage ìš©ëŸ‰ ì´ˆê³¼ - ì¼ë¶€ ë°ì´í„° ì‚­ì œ í•„ìš”")}},removeItem:n=>localStorage.removeItem(n)}}));export{w as c,N as u};
